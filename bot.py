import requests
from bs4 import BeautifulSoup
import telebot
import time
import threading
from telebot import types

# –¢–æ–∫–µ–Ω —Ç–≤–æ–µ–≥–æ –±–æ—Ç–∞
API_TOKEN = '8081177731:AAHi6xBekqBeOxsxweLd7P-075UobWS38j8'
bot = telebot.TeleBot(API_TOKEN)

# ID —á–∞—Ç–∞, –∫—É–¥–∞ –±–æ—Ç –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
CHAT_ID = '437225657'

# URL –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "–ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –¥–∏–∑–∞–π–Ω" –Ω–∞ Kwork
KWORK_URL = "https://kwork.ru/projects?c=41"

# üî• –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ –∑–∞–∫–∞–∑–µ (–¢–û–õ–¨–ö–û —Ç–∞–∫–∏–µ –∑–∞–∫–∞–∑—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º)
KEYWORDS = [
    "–ª–æ–≥–æ—Ç–∏–ø", "–±–∞–Ω–Ω–µ—Ä", "–æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ YouTube", "–æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ Twitch",
    "–∞–≤–∞—Ç–∞—Ä–∫–∞", "–ø—Ä–µ–≤—å—é", "–∏–∫–æ–Ω–∫–∏", "—Ñ–∏—Ä–º–µ–Ω–Ω—ã–π —Å—Ç–∏–ª—å", "–¥–∏–∑–∞–π–Ω –≤–∏–∑–∏—Ç–∫–∏",
    "–¥–∏–∑–∞–π–Ω –±—É–∫–ª–µ—Ç–∞", "–¥–∏–∑–∞–π–Ω —Ñ–ª–∞–µ—Ä–∞", "–¥–∏–∑–∞–π–Ω —É–ø–∞–∫–æ–≤–∫–∏",
    "–∏–Ω—Ñ–æ–≥—Ä–∞—Ñ–∏–∫–∞", "–∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—è", "–ø–æ—Å—Ç–µ—Ä", "—Å—Ç–∏–∫–µ—Ä—ã",
    "–¥–∏–∑–∞–π–Ω –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏", "–≤–µ–±-–¥–∏–∑–∞–π–Ω", "–æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–æ–≤", "–∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–π –¥–∏–∑–∞–π–Ω",
    "–ª–∏—Å—Ç–æ–≤–∫–∞", "—Ñ–ª–∞–µ—Ä", "–¥–∏–∑–∞–π–Ω –ª–∏—Å—Ç–æ–≤–∫–∏", "–¥–∏–∑–∞–π–Ω —Ñ–ª–∞–µ—Ä–∞", "—Ä–µ–∫–ª–∞–º–Ω–∞—è –ª–∏—Å—Ç–æ–≤–∫–∞", 
    "—Ä–µ–∫–ª–∞–º–Ω—ã–π —Ñ–ª–∞–µ—Ä", "–±—Ä–µ–Ω–¥–æ–≤–∞—è –ª–∏—Å—Ç–æ–≤–∫–∞", "–±—Ä–µ–Ω–¥–æ–≤—ã–π —Ñ–ª–∞–µ—Ä", "–ª–∏—Å—Ç–æ–≤–∫–∞ –¥–ª—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è", 
    "—Ñ–ª–∞–µ—Ä –¥–ª—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è", "–ø—Ä–æ–º–æ-–ª–∏—Å—Ç–æ–≤–∫–∞", "–ø—Ä–æ–º–æ-—Ñ–ª–∞–µ—Ä", "–≤–∏–∑–∏—Ç–∫–∞", "–¥–∏–∑–∞–π–Ω –≤–∏–∑–∏—Ç–∫–∏", 
    "–≤–∏–∑–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞", "–±—Ä–µ–Ω–¥–æ–≤–∞—è –≤–∏–∑–∏—Ç–∫–∞", "–∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–∞—è –≤–∏–∑–∏—Ç–∫–∞", "–ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –≤–∏–∑–∏—Ç–∫–∞", 
    "–≤–∏–∑–∏—Ç–∫–∞ –¥–ª—è –∫–æ–º–ø–∞–Ω–∏–∏", "–≤–∏–∑–∏—Ç–∫–∞ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞", "–∫—Ä–µ–∞—Ç–∏–≤–Ω–∞—è –≤–∏–∑–∏—Ç–∫–∞", "–ø—Ä–µ–º–∏—É–º –≤–∏–∑–∏—Ç–∫–∞", 
    "—ç–∫—Å–∫–ª—é–∑–∏–≤–Ω–∞—è –≤–∏–∑–∏—Ç–∫–∞"
]

# üö´ –°—Ç–æ–ø-—Å–ª–æ–≤–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å –≤ –∑–∞–∫–∞–∑–µ ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º)
STOPWORDS = [
    "–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è", "–æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", "–∏–∑–º–µ–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç",
    "—á–µ—Ä—Ç–µ–∂", "–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞", "3D", "–º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ", "–∏–Ω—Ç–µ—Ä—å–µ—Ä", "—ç–∫—Å—Ç–µ—Ä—å–µ—Ä"
]

# –•—Ä–∞–Ω–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –Ω–∞–π–¥–µ–Ω–Ω—ã–π –∑–∞–∫–∞–∑
last_order = None

def get_kwork_orders():
    """–§—É–Ω–∫—Ü–∏—è –ø–∞—Ä—Å–∏—Ç —Å–∞–π—Ç Kwork –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –∑–∞–∫–∞–∑—ã."""
    global last_order
    headers = {"User-Agent": "Mozilla/5.0"}
    response = requests.get(KWORK_URL, headers=headers)

    if response.status_code == 200:
        soup = BeautifulSoup(response.text, "html.parser")
        orders = soup.find_all("div", class_="card__content")  # –ò—â–µ–º –∑–∞–∫–∞–∑—ã

        results = []
        for order in orders:
            title = order.find("a", class_="wants-card__header-title").text.strip()
            link = "https://kwork.ru" + order.find("a")["href"]
            price = order.find("div", class_="wants-card__price").text.strip()

            # –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
            if any(word.lower() in title.lower() for word in KEYWORDS):
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤ –∑–∞–∫–∞–∑–µ –ù–ï–¢ —Å—Ç–æ–ø-—Å–ª–æ–≤
                if not any(stopword.lower() in title.lower() for stopword in STOPWORDS):
                    result = f"üìå {title}\nüí∞ {price}\nüîó {link}"
                    results.append(result)
                    last_order = result  # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –Ω–∞–π–¥–µ–Ω–Ω—ã–π –∑–∞–∫–∞–∑

        return results
    else:
        return ["‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ Kwork"]

def check_orders():
    """–§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∑–∞–∫–∞–∑—ã –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram."""
    sent_orders = set()  # –•—Ä–∞–Ω–∏–º —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã

    while True:
        orders = get_kwork_orders()
        for order in orders:
            if order not in sent_orders:  # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã
                bot.send_message(CHAT_ID, order)
                sent_orders.add(order)

        time.sleep(600)  # –ñ–¥–µ–º 10 –º–∏–Ω—É—Ç –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥—ã /start –∏ –∫–Ω–æ–ø–∫–∏
@bot.message_handler(commands=['start'])
def send_welcome(message):
    markup = types.ReplyKeyboardMarkup(row_width=1, resize_keyboard=True)
    button = types.KeyboardButton("–ü–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–∫–∞–∑")
    markup.add(button)
    bot.send_message(message.chat.id, "–ü—Ä–∏–≤–µ—Ç! –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ–¥—Ö–æ–¥—è—â–∏–π –∑–∞–∫–∞–∑ —Å Kwork.", reply_markup=markup)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ "–ü–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–∫–∞–∑"
@bot.message_handler(func=lambda message: message.text == "–ü–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–∫–∞–∑")
def send_last_order(message):
    if last_order:
        bot.send_message(message.chat.id, last_order)
    else:
        bot.send_message(message.chat.id, "–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –Ω–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –∑–∞–∫–∞–∑–æ–≤.")

# –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –∑–∞–∫–∞–∑–æ–≤ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
threading.Thread(target=check_orders, daemon=True).start()

# –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
bot.polling()
